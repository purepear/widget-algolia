import MuttVue from"@mutt/widgets-vue";import Algoliasearch from"algoliasearch";import stringFormat from"string-format";var script={name:"mutt-algolia",mixins:[MuttVue.mixin],props:{loadingMessage:{type:String,required:!1,default:null},zeroResultsMessage:{type:String,required:!1,default:null}},data:()=>({errors:null,loading:!1,results:null,index:-1,selected:!1,lock:!1,clearOnSelect:null,displayValue:null,displayInitialValue:!1,listScrollTop:0}),created(){document.addEventListener("click",this.documentClick),this.$t||(this.$t=(str=>str))},destroyed(){document.removeEventListener("click",this.documentClick)},methods:{init(){if(!this.field.options.algolia)throw new Error(`Field "${this.field.name}" does not specify an Algolia config!`);let algoliaConfig=this.field.options.algolia;if(!algoliaConfig.id||!algoliaConfig.key)throw new Error(`Field "${this.field.name}" does not specify an Algolia id/key!`);if(this.algoliaClient=Algoliasearch(algoliaConfig.id,algoliaConfig.key),!algoliaConfig.index)throw new Error(`Field "${this.field.name}" does not specify an Algolia index!`);this.algoliaIndexClient=this.algoliaClient.initIndex(algoliaConfig.index),this.clearOnSelect=this.field.options.clearOnSelect,this.field.options.hasOwnProperty("displayInitialValue")&&(this.displayInitialValue=this.field.options.displayInitialValue),this.$nextTick(()=>{if(this.field.value){Object.values(this.field.value).find(value=>null!==value)&&(this.displayValue=this.formatValue(this.field.value))}})},getFieldWrapperClass:()=>"mutt-field-wrapper mutt-field-wrapper-autocomplete",documentClick(e){let el=this.$refs.dropdownMenu,target=e.target;el===target||el.contains(target)||(this.lock=!0)},search(event){if(this.displayValue=this.$refs.inputField.value,"ArrowDown"!==event.key&&"ArrowUp"!==event.key&&"Enter"!==event.key){if(this.lock=!1,""===this.displayValue)return void(this.results=null);const algoliaConfig=this.field.options.algolia;let attributes=["*"];algoliaConfig.attributes&&(attributes=algoliaConfig.attributes);let filters=[];algoliaConfig.filters&&(filters=algoliaConfig.filters),this.loading=!0,this.lock=!0,this.algoliaIndexClient.search(this.displayValue,{attributesToRetrieve:attributes,facetFilters:filters},(err,results)=>{if(err)throw new Error(`Algolia Plugin Error -> ${err}`);this.results=results,this.index=-1,this.loading=!1,this.lock=!1})}},select(index){if("object"!=typeof index&&(this.index=index),this.index>-1&&this.results.hits.length>0){let result=this.results.hits[this.index];this.displayValue=this.formatValue(result),this.$refs.inputField.value=this.formatValue(result),this.value=result,this.field.value=result,this.lock=!0,this.displayInitialValue=!1,this.$emit("select",this.value),this.submitCallback(),this.clearOnSelect&&(this.displayValue=null)}},next(){if(this.$refs.items){const count=this.$refs.items.length;this.goto(this.index<count-1?this.index+1:count?0:-1,"down")}},prev(){if(this.$refs.items){const count=this.$refs.items.length,pos=this.index-1;this.goto(this.selected&&-1!==pos?pos:count-1,"up")}},isListItemVisible(listItemIndex,listItemHeight){const listHeight=this.$refs.list.clientHeight,listItemStart=listItemIndex*listItemHeight,listItemEnd=listItemStart+listItemHeight;if(listItemStart>=this.listScrollTop&&listItemEnd<=this.listScrollTop+listHeight)return!0},goto(i,direction){if(this.selected&&this.$refs.items[this.index]&&this.$refs.items[this.index].classList.remove("active-item"),this.index=i,i>-1&&this.$refs.items.length>0){const list=this.$refs.list,listItem=this.$refs.items[i];if(listItem.classList.add("active-item"),this.selected=!0,0===i)return void(this.listScrollTop=list.scrollTop=0);const listHeight=list.clientHeight,listItemHeight=listItem.clientHeight,listItemOffsetTop=listItem.offsetTop,visibleOffset=Math.floor(listHeight/listItemHeight)-2;"down"===direction?this.isListItemVisible(i+2,listItemHeight)||(this.listScrollTop=list.scrollTop=listItemOffsetTop-listItemHeight*visibleOffset):this.isListItemVisible(i-2,listItemHeight)||(this.listScrollTop=list.scrollTop=listItemOffsetTop-listItemHeight)}},setValue(value){this.value=value,this.value&&(this.displayValue=this.stringFormat(this.field.options.algolia.format,this.value))},formatValue(value){return this.field.options.hasOwnProperty("algolia")&&this.field.options.algolia.hasOwnProperty("format")?this.stringFormat(this.field.options.algolia.format,value):value},checkCallback(){this.field.options.hasOwnProperty("allowFreetype")&&this.field.options.allowFreetype&&this.submitCallback()},submitCallback(){let hits=null;this.results&&this.results.hits&&(hits=this.results.hits),this.field.validate()?this.$emit("callback",{key:this.field.name,value:this.field.value,displayValue:this.displayValue,hits:hits,action:"submit",validated:!0}):this.$emit("callback",{key:this.field.name,value:this.field.value,displayValue:this.displayValue,hits:hits,action:"submit",validated:!1})},focus(){this.$nextTick(()=>{this.$refs.inputField.focus()})},stringFormat:stringFormat},computed:{placeholderStr(){if(this.field.options.algolia.hasOwnProperty("placeholder"))return this.$t(this.field.options.algolia.placeholder)},hasPlaceholder(){return!!this.displayValue&&(!!this.field.options.algolia.hasOwnProperty("placeholder")&&(null!==this.results&&0===this.results.hits.length))},algoliaInputWidth(){return`width: ${this.$refs.algoliaWrapper.getBoundingClientRect().width}px`}}};function normalizeComponent(template,style,script,scopeId,isFunctionalTemplate,moduleIdentifier,shadowMode,createInjector,createInjectorSSR,createInjectorShadow){"boolean"!=typeof shadowMode&&(createInjectorSSR=createInjector,createInjector=shadowMode,shadowMode=!1);var hook,options="function"==typeof script?script.options:script;if(template&&template.render&&(options.render=template.render,options.staticRenderFns=template.staticRenderFns,options._compiled=!0,isFunctionalTemplate&&(options.functional=!0)),scopeId&&(options._scopeId=scopeId),moduleIdentifier?(hook=function hook(context){(context=context||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(context=__VUE_SSR_CONTEXT__),style&&style.call(this,createInjectorSSR(context)),context&&context._registeredComponents&&context._registeredComponents.add(moduleIdentifier)},options._ssrRegister=hook):style&&(hook=shadowMode?function(){style.call(this,createInjectorShadow(this.$root.$options.shadowRoot))}:function(context){style.call(this,createInjector(context))}),hook)if(options.functional){var originalRender=options.render;options.render=function renderWithStyleInjection(h,context){return hook.call(context),originalRender(h,context)}}else{var existing=options.beforeCreate;options.beforeCreate=existing?[].concat(existing,hook):[hook]}return script}var normalizeComponent_1=normalizeComponent;const __vue_script__=script;var __vue_render__=function(){var _vm=this,_h=_vm.$createElement,_c=_vm._self._c||_h;return _vm.field?_c("div",{ref:"dropdownMenu",class:_vm.getFieldWrapperClass()},[_c("label-widget",{attrs:{field:_vm.field,fieldId:_vm.getFieldId()}}),_vm._v(" "),_c("div",[_c("span",{ref:"algoliaWrapper",staticClass:"mutt-input-wrapper-algolia"},[_vm.isReadOnly?_c("readonly-widget",{attrs:{value:_vm.stringFormat(_vm.field.options.algolia.format,_vm.field.value)}}):_vm._e(),_vm._v(" "),_vm.isReadOnly?_vm._e():_c("input",{ref:"inputField",staticClass:"mutt-field mutt-field-text mutt-field-text--large mutt-field-algolia",attrs:{autocomplete:"off",autocorrect:"off",type:"text",name:"searchTerm",placeholder:_vm.placeholderStr},on:{blur:_vm.checkCallback,keydown:[function($event){return!$event.type.indexOf("key")&&_vm._k($event.keyCode,"down",40,$event.key,["Down","ArrowDown"])?null:_vm.next($event)},function($event){return!$event.type.indexOf("key")&&_vm._k($event.keyCode,"up",38,$event.key,["Up","ArrowUp"])?null:_vm.prev($event)},function($event){return!$event.type.indexOf("key")&&_vm._k($event.keyCode,"enter",13,$event.key,"Enter")?null:($event.preventDefault(),_vm.select($event))}],keyup:_vm.search}})],1),_vm._v(" "),_vm.displayInitialValue&&!_vm.isReadOnly?_c("p",[_vm._v("\n      "+_vm._s(_vm.displayValue)+"\n    ")]):_vm._e()]),_vm._v(" "),_vm.loading?_c("div",{staticClass:"loading",style:_vm.algoliaInputWidth},[_vm.loadingMessage?_c("p",[_vm._v(_vm._s(_vm.loadingMessage))]):_c("p",[_vm._v(_vm._s(_vm.$t("Loading...")))])]):_vm._e(),_vm._v(" "),!_vm.lock&&_vm.results&&_vm.results.hits.length>0?_c("div",{staticClass:"mutt-dropdown-autocomplete",style:_vm.algoliaInputWidth},[_c("ul",{ref:"list",staticClass:"mutt-dropdown-autocomplete__list"},_vm._l(_vm.results.hits,function(result,index){return _c("li",{ref:"items",refInFor:!0,staticClass:"mutt-dropdown-autocomplete__listitem",on:{click:function($event){return _vm.select(index)}}},[_vm._v("\n        "+_vm._s(_vm.stringFormat(_vm.field.options.algolia.format,result))+"\n      ")])}),0)]):!_vm.loading&&_vm.hasPlaceholder&&_vm.results&&0===_vm.results.hits.length?_c("div",{staticClass:"mutt-dropdown-autocomplete--error",style:_vm.algoliaInputWidth},[_c("ul",{ref:"list",staticClass:"mutt-dropdown-autocomplete__list--error"},[_c("li",{staticClass:"mutt-dropdown-autocomplete__listitem--error bold"},[_vm._v("\n        "+_vm._s(_vm.$t("We can't find"))+" '"+_vm._s(_vm.displayValue)+"'."),_c("br"),_vm._v(" "),_vm.zeroResultsMessage?_c("span",[_vm._v(_vm._s(_vm.zeroResultsMessage))]):_c("span",[_vm._v("\n          "+_vm._s(_vm.$t("Sorry to ask, but have you checked the spelling?"))+"\n        ")])])])]):_vm._e(),_vm._v(" "),_c("help-widget",{attrs:{field:_vm.field}}),_vm._v(" "),_vm._l(_vm.field.object,function(objField){return _vm.isReadOnly?_vm._e():_c("error-widget",{key:"autocomplete-error-"+objField.id,attrs:{field:objField,errors:objField.errors,errorClass:_vm.getErrorClass()}})})],2):_vm._e()},__vue_staticRenderFns__=[];__vue_render__._withStripped=!0;const __vue_inject_styles__=void 0,__vue_scope_id__=void 0,__vue_module_identifier__=void 0,__vue_is_functional_template__=!1;var algolia=normalizeComponent_1({render:__vue_render__,staticRenderFns:__vue_staticRenderFns__},void 0,__vue_script__,void 0,!1,void 0,void 0,void 0);export default algolia;
